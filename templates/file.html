{% extends "base.html" %} {% block content %} {% set card_base = "rounded-2xl
border border-gray-800 bg-gray-900/70 p-6 shadow-xl shadow-gray-950/40
backdrop-blur" %} {% set card_subtle = "rounded-2xl border border-gray-800
bg-gray-900/60 p-5 text-gray-200 shadow-lg shadow-gray-950/40" %} {% set
button_primary = "inline-flex items-center justify-center gap-2 rounded-lg
bg-sky-500 px-4 py-2 text-sm font-semibold text-gray-950 shadow-sm transition
hover:bg-sky-400 focus-visible:outline focus-visible:outline-2
focus-visible:outline-offset-2 focus-visible:outline-sky-300" %} {% set
button_outline = "inline-flex items-center justify-center gap-2 rounded-lg
border border-gray-700 px-4 py-2 text-sm font-semibold text-gray-200 transition
hover:border-sky-400 hover:text-white focus-visible:outline
focus-visible:outline-2 focus-visible:outline-offset-2
focus-visible:outline-sky-300" %} {% set button_danger = "inline-flex
items-center justify-center gap-2 rounded-lg border border-rose-500/70 px-4 py-2
text-sm font-semibold text-rose-200 transition hover:bg-rose-500/10
focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2
focus-visible:outline-rose-400" %} {% set copy_button = "relative inline-flex
items-center justify-center gap-2 rounded-lg border border-gray-700
bg-gray-900/70 px-4 py-2 text-sm font-semibold text-gray-100 transition
hover:border-sky-400 hover:text-white focus-visible:outline
focus-visible:outline-2 focus-visible:outline-offset-2
focus-visible:outline-sky-300 data-[copy-state=copied]:after:absolute
data-[copy-state=copied]:after:-top-10 data-[copy-state=copied]:after:left-1/2
data-[copy-state=copied]:after:-translate-x-1/2
data-[copy-state=copied]:after:rounded-full
data-[copy-state=copied]:after:bg-emerald-400
data-[copy-state=copied]:after:px-3 data-[copy-state=copied]:after:py-1
data-[copy-state=copied]:after:text-xs
data-[copy-state=copied]:after:font-semibold
data-[copy-state=copied]:after:text-gray-950
data-[copy-state=copied]:after:shadow-lg
data-[copy-state=copied]:after:content-['Copied!']
data-[copy-state=copied]:after:opacity-100
data-[copy-state=copied]:after:transition
data-[copy-state=copied]:after:duration-300
data-[copy-state=copied]:after:ease-out
data-[copy-state=copied]:after:whitespace-nowrap" %}

<section class="mx-auto w-full max-w-4xl space-y-8 py-10">
  <div class="space-y-2">
    <h1 class="flex items-center gap-3 text-3xl font-semibold text-white">
      <i data-feather="file-text" class="h-7 w-7 text-sky-400"></i>
      File details
    </h1>
    <p class="text-sm text-gray-400">
      Share this code so others can check the status and download the file
      securely.
    </p>
  </div>

  <article class="{{ card_base }} space-y-6">
    <header class="flex items-start gap-3">
      <i data-feather="file" class="h-6 w-6 flex-shrink-0 text-gray-400"></i>
      <h2 class="break-words text-xl font-semibold text-white">
        {{ original_name }}
      </h2>
    </header>

    <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
      <label
        for="lookup-code"
        class="flex items-center gap-2 font-semibold text-sky-200"
      >
        <span class="inline-flex items-center gap-2">
          <i data-feather="hash" class="h-4 w-4"></i>
          Code
        </span>
      </label>
      <input
        id="lookup-code"
        type="text"
        value="{{ code }}"
        readonly
        class="w-full rounded-lg border border-sky-400/50 bg-gray-950/60 px-3 py-2 font-mono text-lg font-semibold text-sky-100 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-500/40"
      />
      <button
        type="button"
        class="{{ copy_button }} whitespace-nowrap"
        data-copy
        data-copy-target="#lookup-code"
      >
        <i data-feather="copy" aria-hidden="true" class="h-4 w-4"></i>
        Copy
      </button>
    </div>

    <dl
      class="grid grid-cols-[minmax(160px,1fr)_minmax(0,2fr)] gap-x-6 gap-y-4 text-sm text-gray-200"
    >
      <div class="contents">
        <dt class="flex items-center gap-2 font-semibold text-gray-400">
          <i data-feather="file" class="h-4 w-4"></i>
          File name
        </dt>
        <dd class="font-medium text-white">{{ original_name }}</dd>
      </div>
      <div class="contents">
        <dt class="flex items-center gap-2 font-semibold text-gray-400">
          <i data-feather="hard-drive" class="h-4 w-4"></i>
          Size
        </dt>
        <dd><strong>{{ size_display }}</strong></dd>
      </div>
      <div class="contents">
        <dt class="flex items-center gap-2 font-semibold text-gray-400">
          <i data-feather="upload" class="h-4 w-4"></i>
          Uploaded
        </dt>
        <dd><time class="text-gray-300">{{ created_display }}</time></dd>
      </div>
      <div class="contents">
        <dt class="flex items-center gap-2 font-semibold text-gray-400">
          <i data-feather="clock" class="h-4 w-4"></i>
          Expires
        </dt>
        <dd>
          {% if let Some(expires) = expires_display %}
          <strong class="text-gray-300">{{ expires }}</strong>
          {% else %}
          <span class="text-gray-500">Never</span>
          {% endif %}
        </dd>
      </div>
      {% if let Some(kind) = content_type %}
      <div class="contents">
        <dt class="flex items-center gap-2 font-semibold text-gray-400">
          <i data-feather="tag" class="h-4 w-4"></i>
          Content type
        </dt>
        <dd>
          <code class="rounded bg-gray-900/70 px-2 py-1 text-xs text-gray-200"
            >{{ kind }}</code
          >
        </dd>
      </div>
      {% endif %} {% if let Some(signature) = checksum %}
      <div class="contents">
        <dt class="flex items-center gap-2 font-semibold text-gray-400">
          <i data-feather="check-circle" class="h-4 w-4"></i>
          Checksum
        </dt>
        <dd>
          <code
            class="block break-all rounded bg-gray-900/70 px-2 py-1 text-xs text-gray-200"
            >{{ signature }}</code
          >
        </dd>
      </div>
      {% endif %}
    </dl>

    {% if can_preview %}
    <section class="{{ card_subtle }} space-y-4" id="file-preview">
      <header class="flex items-center justify-between">
        <h3 class="flex items-center gap-2 text-lg font-semibold text-white">
          <i data-feather="eye" class="h-5 w-5"></i>
          File preview
        </h3>
        <div class="flex gap-2">
          <button
            type="button"
            id="toggle-preview-mode"
            class="{{ copy_button }}"
            title="Toggle between Monaco editor and plain text preview"
          >
            <i data-feather="code" aria-hidden="true" class="h-4 w-4"></i>
            <span id="preview-mode-text">Toggle Editor</span>
          </button>
          <button
            type="button"
            class="{{ copy_button }}"
            data-copy
            data-copy-target="#file-preview-content"
          >
            <i data-feather="copy" aria-hidden="true" class="h-4 w-4"></i>
            Copy
          </button>
        </div>
      </header>
      <div class="rounded-lg border border-gray-800 bg-gray-950/60 p-4">
        <div
          id="monaco-editor-container"
          style="height: 400px; display: none"
        ></div>
        <pre
          id="file-preview-content"
          class="max-h-96 overflow-auto whitespace-pre-wrap break-words font-mono text-sm text-gray-200"
        >
{{ preview_content }}</pre
        >
      </div>
    </section>
    {% else if preview_blocked_by_size %}
    <p class="flex items-center gap-2 text-sm text-gray-400">
      <i data-feather="info" class="h-4 w-4"></i>
      File too large to preview (limit {{ preview_max_size_display }}).
    </p>
    {% endif %}

    <footer>
      <div class="button-group flex flex-col gap-3 sm:flex-row">
        <button
          type="button"
          class="{{ button_primary }} sm:flex-1"
          onclick="handleDownload(event, '{{ code }}')"
        >
          <i data-feather="download" class="h-4 w-4"></i>
          Download file
        </button>
        <form
          method="post"
          action="/f/{{ code }}/link"
          hx-post="/f/{{ code }}/link"
          hx-target="#direct-link-output"
          hx-swap="outerHTML"
          hx-disabled-elt="button"
          class="sm:flex-1"
        >
          {% if let Some(csrf) = layout.csrf %}
          <input type="hidden" name="csrf_token" value="{{ csrf.token }}" />
          {% endif %}
          <button
            type="submit"
            class="{{ button_outline }} w-full justify-center"
          >
            <i data-feather="link" class="h-4 w-4"></i>
            Generate link
          </button>
        </form>
        {% if can_delete %}
        <form
          method="post"
          action="/f/{{ code }}/delete"
          class="sm:flex-1"
          data-delete-form
        >
          {% if let Some(csrf) = layout.csrf %}
          <input type="hidden" name="csrf_token" value="{{ csrf.token }}" />
          {% endif %}
          <button
            type="submit"
            class="{{ button_danger }} w-full justify-center"
            data-delete-button
          >
            <i data-feather="trash-2" class="h-4 w-4"></i>
            Delete file
          </button>
        </form>
        {% endif %}
      </div>
    </footer>
  </article>

  <div
    id="direct-link-output"
    class="{{ card_subtle }}"
    role="region"
    aria-live="polite"
  >
    <p class="flex items-center justify-center gap-2 text-sm text-gray-300">
      <i data-feather="info" class="h-5 w-5"></i>
      Generate a direct link to download this file directly.
    </p>
  </div>
</section>
{% endblock %} {% block body_scripts %}
<script>
  function activateIcons() {
    "use strict";

    if (typeof activateFeatherIcons === "function") {
      activateFeatherIcons();
    } else if (window.feather) {
      window.feather.replace();
    }
  }

  function resolveCsrfToken(scope) {
    "use strict";

    const root =
      scope && typeof scope.querySelector === "function" ? scope : document;
    const field = root.querySelector('input[name="csrf_token"]');
    if (field && field.value) {
      return field.value;
    }

    const metaToken = document.querySelector('meta[name="csrf-token"]');
    return metaToken?.getAttribute("content") || "";
  }

  async function requestDirectLink(code, csrfToken) {
    "use strict";

    if (!csrfToken) {
      throw new Error("Missing CSRF token");
    }

    const payload = new URLSearchParams();
    payload.set("csrf_token", csrfToken);

    const response = await fetch(`/f/${code}/link`, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
      },
      body: payload.toString(),
    });

    if (!response.ok) {
      throw new Error(
        `Failed to generate download link (status ${response.status})`
      );
    }

    const html = (await response.text()).trim();
    if (!html) {
      throw new Error("Empty response while generating link");
    }

    const template = document.createElement("template");
    template.innerHTML = html;
    const snippet = template.content.firstElementChild;

    if (!snippet) {
      throw new Error("Failed to parse download snippet");
    }

    const linkInput = snippet.querySelector('input[type="text"]');
    if (!linkInput || !linkInput.value) {
      throw new Error("Download link missing in response");
    }

    return { snippet, directUrl: linkInput.value };
  }

  async function handleDownload(event, code) {
    "use strict";

    const button = event.currentTarget;
    const originalContent = button.innerHTML;
    const directLinkContainer = document.getElementById("direct-link-output");

    try {
      button.disabled = true;
      button.innerHTML = '<i data-feather="loader"></i> Generating...';
      activateIcons();

      const siblingForm = button
        .closest(".button-group")
        ?.querySelector("form");
      const csrfToken = resolveCsrfToken(siblingForm);
      const { snippet, directUrl } = await requestDirectLink(code, csrfToken);

      if (directLinkContainer) {
        directLinkContainer.replaceWith(snippet);
      }

      activateIcons();

      button.innerHTML = '<i data-feather="check"></i> Downloading...';
      activateIcons();
      window.location.href = directUrl;

      setTimeout(() => {
        button.disabled = false;
        button.innerHTML = originalContent;
        activateIcons();
      }, 2000);
    } catch (error) {
      console.error("Download error:", error);
      button.innerHTML = '<i data-feather="alert-circle"></i> Error';
      activateIcons();

      setTimeout(() => {
        button.disabled = false;
        button.innerHTML = originalContent;
        activateIcons();
      }, 2500);
    }
  }

  function attachDeleteHandlers() {
    "use strict";

    document.querySelectorAll("[data-delete-form]").forEach((form) => {
      form.addEventListener("submit", (event) => {
        const button = form.querySelector("[data-delete-button]");
        const confirmed = window.confirm(
          "This will permanently remove the shared file. Continue?"
        );

        if (!confirmed) {
          event.preventDefault();
          return;
        }

        if (button) {
          button.disabled = true;
          button.innerHTML = '<i data-feather="loader"></i> Deleting...';
          activateIcons();
        }
      });
    });
  }

  let monacoEditor = null;
  let isMonacoMode = false;
  let fileContent = "";
  let fileLanguage = "plaintext";

  function getMonacoLanguageFromFilename(filename) {
    const extension = filename.split(".").pop()?.toLowerCase();
    const languageMap = {
      js: "javascript",
      mjs: "javascript",
      cjs: "javascript",
      jsx: "javascript",
      ts: "typescript",
      tsx: "typescript",
      py: "python",
      rs: "rust",
      go: "go",
      java: "java",
      c: "c",
      h: "c",
      cpp: "cpp",
      cxx: "cpp",
      cc: "cpp",
      hpp: "cpp",
      cs: "csharp",
      php: "php",
      rb: "ruby",
      swift: "swift",
      kt: "kotlin",
      scala: "scala",
      html: "html",
      htm: "html",
      css: "css",
      scss: "scss",
      sass: "sass",
      less: "less",
      json: "json",
      xml: "xml",
      yaml: "yaml",
      yml: "yaml",
      toml: "toml",
      ini: "ini",
      sql: "sql",
      sh: "shell",
      bash: "shell",
      zsh: "shell",
      fish: "shell",
      ps1: "powershell",
      dockerfile: "dockerfile",
      md: "markdown",
      markdown: "markdown",
      lua: "lua",
      r: "r",
      vue: "html",
      svelte: "html",
    };

    return languageMap[extension] || "plaintext";
  }

  // Load Monaco editor on demand
  let monacoLoaded = false;

  async function loadMonacoEditor() {
    if (monacoLoaded) return;

    return new Promise((resolve) => {
      // Set up Monaco editor
      require.config({
        paths: { vs: "https://unpkg.com/monaco-editor@0.52.2/min/vs" },
      });
      require(["vs/editor/editor.main"], function () {
        monacoLoaded = true;
        resolve();
      });
    });
  }

  async function initializeMonacoEditor(content, filename) {
    if (monacoEditor) {
      monacoEditor.dispose();
    }

    // Load Monaco editor if not already loaded
    await loadMonacoEditor();

    const container = document.getElementById("monaco-editor-container");
    if (!container) {
      return;
    }

    fileLanguage = getMonacoLanguageFromFilename(filename);

    monacoEditor = monaco.editor.create(container, {
      value: content,
      language: fileLanguage,
      theme: "vs-dark",
      readOnly: false,
      minimap: { enabled: true },
      scrollBeyondLastLine: false,
      fontSize: 14,
      lineNumbers: "on",
      renderWhitespace: "selection",
      wordWrap: "on",
      automaticLayout: true,
    });
  }

  // Toggle between Monaco editor and plain text preview
  async function togglePreviewMode() {
    const monacoContainer = document.getElementById("monaco-editor-container");
    const plainTextContainer = document.getElementById("file-preview-content");
    const modeText = document.getElementById("preview-mode-text");

    if (!isMonacoMode) {
      // Switch to Monaco editor
      // Initialize Monaco editor on first use
      if (!monacoEditor) {
        const toggleButton = document.getElementById("toggle-preview-mode");
        toggleButton.innerHTML =
          '<i data-feather="loader" class="h-4 w-4"></i> Loading...';
        activateIcons();

        await initializeMonacoEditor(fileContent, "{{ original_name }}");

        toggleButton.innerHTML =
          '<i data-feather="code" class="h-4 w-4"></i> <span id="preview-mode-text">Monaco</span>';
        activateIcons();
      }

      monacoContainer.style.display = "block";
      plainTextContainer.style.display = "none";
      modeText.textContent = "Monaco";
      isMonacoMode = true;

      setTimeout(() => {
        monacoEditor.layout();
      }, 100);
    } else {
      // Switch to plain text
      monacoContainer.style.display = "none";
      plainTextContainer.style.display = "block";
      modeText.textContent = "Toggle Editor";
      isMonacoMode = false;
    }
  }

  async function loadPreview(code) {
    "use strict";

    const previewContainer = document.getElementById("file-preview-content");
    if (!previewContainer) {
      return;
    }

    try {
      const csrfToken = resolveCsrfToken();
      if (!csrfToken) {
        throw new Error("Missing CSRF token for preview request");
      }

      const { directUrl } = await requestDirectLink(code, csrfToken);
      const response = await fetch(directUrl);

      if (!response.ok) {
        throw new Error(
          `Failed to fetch file content (status ${response.status})`
        );
      }

      fileContent = await response.text();
      previewContainer.textContent = fileContent;

      const toggleButton = document.getElementById("toggle-preview-mode");
      if (toggleButton) {
        toggleButton.addEventListener("click", togglePreviewMode);
      }
    } catch (error) {
      console.error("Preview loading error:", error);
      previewContainer.textContent = "Preview unavailable.";
    } finally {
      activateIcons();
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    attachDeleteHandlers();
    if (document.getElementById("file-preview-content")) {
      loadPreview("{{ code }}").catch((error) => {
        console.error("Preview init error:", error);
      });
    }
  });
</script>
{% endblock %}
