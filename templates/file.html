{% extends "base.html" %}

{% block content %}
<section style="max-width: 800px; margin: 0 auto;">
    <hgroup>
        <h1>
            <i data-feather="file-text" style="width: 28px; height: 28px; vertical-align: middle; margin-right: 0.5rem;"></i>
            File details
        </h1>
        <p>Share the code below to let anyone check the status of this file.</p>
    </hgroup>

    <article>
        <header>
            <h2 style="display: flex; align-items: center; gap: 0.5rem; word-break: break-all;">
                <i data-feather="file" style="width: 24px; height: 24px; flex-shrink: 0;"></i>
                {{ original_name }}
            </h2>
        </header>

        <div class="card" style="background: color-mix(in srgb, var(--pico-primary) 10%, var(--pico-card-background-color)); border-color: var(--pico-primary);">
            <label for="lookup-code" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--pico-primary);">
                <i data-feather="hash" style="width: 16px; height: 16px; vertical-align: middle;"></i>
                Share Code
            </label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input id="lookup-code" type="text" value="{{ code }}" readonly style="flex: 1; font-family: monospace; font-size: 1.1rem; font-weight: bold;">
                <button type="button" class="secondary outline" data-copy data-copy-target="#lookup-code" style="white-space: nowrap;">
                    <i data-feather="copy" aria-hidden="true"></i>
                    Copy
                </button>
            </div>
        </div>

        <dl>
            <dt><i data-feather="file" style="width: 14px; height: 14px; vertical-align: middle;"></i> File name</dt>
            <dd>{{ original_name }}</dd>
            
            <dt><i data-feather="hard-drive" style="width: 14px; height: 14px; vertical-align: middle;"></i> Size</dt>
            <dd><strong>{{ size_display }}</strong></dd>
            
            <dt><i data-feather="upload" style="width: 14px; height: 14px; vertical-align: middle;"></i> Uploaded</dt>
            <dd><time>{{ created_display }}</time></dd>
            
            <dt><i data-feather="clock" style="width: 14px; height: 14px; vertical-align: middle;"></i> Expires</dt>
            <dd>
                {% if let Some(expires) = expires_display %}
                <strong style="color: var(--pico-primary);">{{ expires }}</strong>
                {% else %}
                <span style="color: var(--pico-muted-color);">Never</span>
                {% endif %}
            </dd>
            
            {% if let Some(kind) = content_type %}
            <dt><i data-feather="tag" style="width: 14px; height: 14px; vertical-align: middle;"></i> Content type</dt>
            <dd><code style="font-size: 0.875rem;">{{ kind }}</code></dd>
            {% endif %}
            
            {% if let Some(signature) = checksum %}
            <dt><i data-feather="check-circle" style="width: 14px; height: 14px; vertical-align: middle;"></i> Checksum</dt>
            <dd><code style="font-size: 0.75rem; word-break: break-all;">{{ signature }}</code></dd>
            {% endif %}
        </dl>

        <footer>
            <div class="button-group">
                <button 
                    type="button" 
                    class="icon-button"
                    style="flex: 1;"
                    onclick="handleDownload(event, '{{ code }}')">
                    <i data-feather="download"></i>
                    Download file
                </button>
                <form method="post" action="/f/{{ code }}/link"
                      hx-post="/f/{{ code }}/link"
                      hx-target="#direct-link-output"
                      hx-swap="outerHTML"
                      hx-disabled-elt="button"
                      style="flex: 1;">
                    {% if let Some(csrf) = layout.csrf %}
                    <input type="hidden" name="csrf_token" value="{{ csrf.token }}">
                    {% endif %}
                    <button type="submit" class="icon-button secondary outline" style="width: 100%;">
                        <i data-feather="link"></i>
                        Generate link
                    </button>
                </form>
                {% if can_delete %}
                <form method="post" action="/f/{{ code }}/delete" style="flex: 1;" data-delete-form>
                    {% if let Some(csrf) = layout.csrf %}
                    <input type="hidden" name="csrf_token" value="{{ csrf.token }}">
                    {% endif %}
                    <button type="submit" class="icon-button secondary outline" style="width: 100%; color: var(--pico-del-color);" data-delete-button>
                        <i data-feather="trash-2"></i>
                        Delete file
                    </button>
                </form>
                {% endif %}
            </div>
        </footer>
    </article>

    <div id="direct-link-output" class="card" style="background: color-mix(in srgb, var(--pico-muted-color) 5%, var(--pico-card-background-color));" role="region" aria-live="polite">
        <p style="text-align: center; color: var(--pico-muted-color); margin: 0;">
            <i data-feather="info" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 0.5rem;"></i>
            Generate a direct link to download this file directly.
        </p>
    </div>
</section>
{% endblock %}

{% block body_scripts %}
<script>
    async function handleDownload(event, code) {
        "use strict";

        const button = event.currentTarget;
        const originalContent = button.innerHTML;
        const directLinkContainer = document.getElementById("direct-link-output");

        const activateIcons = () => {
            if (typeof activateFeatherIcons === "function") {
                activateFeatherIcons();
            } else if (window.feather) {
                window.feather.replace();
            }
        };

        try {
            button.disabled = true;
            button.innerHTML = '<i data-feather="loader"></i> Generating...';
            activateIcons();

            const siblingForm = button.closest(".button-group")?.querySelector("form");
            const csrfTokenField = siblingForm?.querySelector('input[name="csrf_token"]');
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            const csrfToken = csrfTokenField?.value || metaToken?.getAttribute("content") || "";

            if (!csrfToken) {
                throw new Error("Missing CSRF token");
            }

            const payload = new URLSearchParams();
            payload.set("csrf_token", csrfToken);

            const response = await fetch(`/f/${code}/link`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
                },
                body: payload.toString()
            });

            if (!response.ok) {
                throw new Error(`Failed to generate download link (status ${response.status})`);
            }

            const html = (await response.text()).trim();
            if (!html) {
                throw new Error("Empty response while generating link");
            }

            const template = document.createElement("template");
            template.innerHTML = html;
            const snippet = template.content.firstElementChild;

            if (!snippet) {
                throw new Error("Failed to parse download snippet");
            }

            if (directLinkContainer) {
                directLinkContainer.replaceWith(snippet);
            }

            activateIcons();

            const linkInput = snippet.querySelector('input[type="text"]');
            if (!linkInput || !linkInput.value) {
                throw new Error("Download link missing in response");
            }

            button.innerHTML = '<i data-feather="check"></i> Downloading...';
            activateIcons();
            window.location.href = linkInput.value;

            setTimeout(() => {
                button.disabled = false;
                button.innerHTML = originalContent;
                activateIcons();
            }, 2000);
        } catch (error) {
            console.error("Download error:", error);
            button.innerHTML = '<i data-feather="alert-circle"></i> Error';
            activateIcons();

            setTimeout(() => {
                button.disabled = false;
                button.innerHTML = originalContent;
                activateIcons();
            }, 2500);
        }
    }

    function attachDeleteHandlers() {
        "use strict";

        const activateIcons = () => {
            if (typeof activateFeatherIcons === "function") {
                activateFeatherIcons();
            } else if (window.feather) {
                window.feather.replace();
            }
        };

        document.querySelectorAll("[data-delete-form]").forEach((form) => {
            form.addEventListener("submit", (event) => {
                const button = form.querySelector("[data-delete-button]");
                const confirmed = window.confirm(
                    "This will permanently remove the shared file. Continue?"
                );

                if (!confirmed) {
                    event.preventDefault();
                    return;
                }

                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<i data-feather="loader"></i> Deleting...';
                    activateIcons();
                }
            });
        });
    }

    document.addEventListener("DOMContentLoaded", attachDeleteHandlers);
</script>
{% endblock %}
