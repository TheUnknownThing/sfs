{% extends "base.html" %}

{% block content %}
{% set card_base = "rounded-2xl border border-gray-800 bg-gray-900/70 p-6 shadow-xl shadow-gray-950/40 backdrop-blur" %}
{% set button_primary = "inline-flex items-center justify-center gap-2 rounded-lg bg-sky-500 px-4 py-2 text-sm font-semibold text-gray-950 shadow-sm transition hover:bg-sky-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-300" %}
{% set input_class = "mt-3 w-full rounded-lg border border-gray-800 bg-gray-900/70 px-3 py-2 text-base text-gray-100 placeholder:text-gray-500 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-500/40" %}

<section class="mx-auto w-full max-w-3xl space-y-6 py-10">
    <div class="space-y-2">
        <h1 class="flex items-center gap-3 text-3xl font-semibold text-white">
            <i data-feather="upload" class="h-7 w-7 text-sky-400"></i>
            Upload a file
        </h1>
        <p class="text-sm text-gray-400">
            Maximum size: <strong class="text-gray-200">{{ max_file_size_display }}</strong>
        </p>
    </div>

    {% if let Some(error) = error_message %}
    <div class="rounded-2xl border border-rose-500/60 bg-rose-500/10 p-4 text-sm text-rose-100 shadow-lg shadow-rose-500/20" role="alert">
        <strong class="font-semibold">Error:</strong> {{ error }}
    </div>
    {% endif %}

    <article class="{{ card_base }} space-y-6">
        <form method="post" action="/upload" enctype="multipart/form-data" class="space-y-6">
            
            <div>
                <span class="flex items-center gap-2 text-sm font-semibold text-gray-200">
                    <i data-feather="file" class="h-4 w-4 text-gray-400"></i>
                    File
                </span>
                
                <label 
                    id="drop-zone" for="file-upload" 
                    class="relative mt-3 flex cursor-pointer justify-center rounded-lg border border-dashed border-gray-700 bg-gray-900/70 px-6 py-10 transition hover:border-sky-400 hover:bg-gray-900/90"
                >
                    <div id="drop-zone-text" class="text-center">
                        <i data-feather="upload-cloud" class="mx-auto h-12 w-12 text-gray-500"></i>
                        <p class="mt-4 text-sm text-gray-400">
                            <span class="font-semibold text-sky-400">Click to upload</span> or drag and drop
                        </p>
                        <p class="text-xs text-gray-500">Use any file up to {{ max_file_size_display }}</p>
                    </div>

                    <div id="file-display" class="hidden text-center">
                        <i data-feather="file-text" class="mx-auto h-12 w-12 text-sky-400"></i>
                        <p id="file-name" class="mt-4 text-sm font-semibold text-gray-200"></p>
                        <p class="text-xs text-gray-500">Click or drag another file to replace</p>
                    </div>
                    
                    <input
                        id="file-upload" type="file"
                        name="file"
                        required
                        aria-required="true"
                        class="sr-only"
                    />
                </label>
            </div>

            <label class="block text-sm font-semibold text-gray-200">
                <span class="flex items-center gap-2">
                    <i data-feather="clock" class="h-4 w-4 text-gray-400"></i>
                    Expires in (hours)
                </span>
                <input
                    type="number"
                    name="expires_in"
                    min="1"
                    max="{{ max_expiration_hours }}"
                    value="{{ expires_in_value }}"
                    required
                    aria-required="true"
                    class="{{ input_class }}"
                />
                <small class="mt-2 block text-sm text-gray-400">Files will be removed automatically after the selected time.</small>
            </label>

            <label class="block text-sm font-semibold text-gray-200">
                <span class="flex items-center gap-2">
                    <i data-feather="edit-3" class="h-4 w-4 text-gray-400"></i>
                    Notes <span class="text-sm font-normal text-gray-400">(optional)</span>
                </span>
                <textarea
                    name="notes"
                    rows="3"
                    placeholder="Internal notes for this upload"
                    class="{{ input_class }} min-h-[120px]"
                ></textarea>
            </label>

            {% if let Some(csrf) = layout.csrf %}
            <input type="hidden" name="csrf_token" value="{{ csrf.token }}" />
            {% endif %}

            <button type="submit" class="{{ button_primary }} w-full justify-center">
                <i data-feather="upload-cloud" class="h-4 w-4"></i>
                Start upload
            </button>
        </form>
    </article>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-upload');
        const dropZoneText = document.getElementById('drop-zone-text');
        const fileDisplay = document.getElementById('file-display');
        const fileNameDisplay = document.getElementById('file-name');
        
        // CSS classes for styling the drop zone when a file is dragged over
        const activeDragClasses = ['border-sky-400', 'bg-gray-900/90'];
        const inactiveDragClasses = ['border-gray-700'];

        // Prevent default browser behavior for drag events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        // Highlight drop zone on drag enter/over
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove(...inactiveDragClasses);
                dropZone.classList.add(...activeDragClasses);
            });
        });

        // Remove highlight on drag leave or drop
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove(...activeDragClasses);
                dropZone.classList.add(...inactiveDragClasses);
            });
        });

        // Handle file drop
        dropZone.addEventListener('drop', (e) => {
            // Get the dropped files from the event
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Assign the files to the hidden file input
                fileInput.files = files; 
                // Trigger the 'change' event on the file input
                fileInput.dispatchEvent(new Event('change', { 'bubbles': true }));
            }
        });
        
        // Update UI when file is selected (from either click or drop)
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                
                // Update the file name display
                fileNameDisplay.textContent = fileName;
                
                // Show file info, hide default "drag" text
                dropZoneText.classList.add('hidden');
                fileDisplay.classList.remove('hidden');
                
                // If you're using the Feather Icons library, this re-renders the icon
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }
        });
    });
</script>
{% endblock %}