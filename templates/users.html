{% extends "base.html" %}

{% block content %}
{% set card_base = "rounded-2xl border border-gray-800 bg-gray-900/70 p-6 shadow-xl shadow-gray-950/40 backdrop-blur" %}
{% set alert_success = "rounded-2xl border border-emerald-500/60 bg-emerald-500/10 p-4 text-sm text-emerald-100 shadow-lg shadow-emerald-500/20" %}
{% set alert_error = "rounded-2xl border border-rose-500/60 bg-rose-500/10 p-4 text-sm text-rose-100 shadow-lg shadow-rose-500/20" %}
{% set button_primary = "inline-flex items-center justify-center gap-2 rounded-lg bg-sky-500 px-4 py-2 text-sm font-semibold text-gray-950 shadow-sm transition hover:bg-sky-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-300" %}
{% set button_secondary = "inline-flex items-center justify-center gap-2 rounded-lg bg-gray-800 px-4 py-2 text-sm font-semibold text-gray-100 shadow-sm transition hover:bg-gray-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-300" %}
{% set button_danger = "inline-flex items-center justify-center gap-2 rounded-lg border border-rose-500/70 px-4 py-2 text-sm font-semibold text-rose-200 transition hover:bg-rose-500/10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-400" %}
{% set input_class = "mt-2 w-full rounded-lg border border-gray-800 bg-gray-900/70 px-3 py-2 text-base text-gray-100 placeholder:text-gray-500 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-500/40" %}

<section class="mx-auto w-full max-w-6xl space-y-8 py-10">
    <div class="space-y-2">
        <h1 class="flex items-center gap-3 text-3xl font-semibold text-white">
            <i data-feather="users" class="h-7 w-7 text-sky-400"></i>
            User management
        </h1>
        <p class="text-sm text-gray-400">Manage access, grant administrators, and keep account details current.</p>
    </div>

    {% if let Some(message) = success_message %}
    <div class="{{ alert_success }}" role="status">
        <strong class="font-semibold">âœ“ Success!</strong> {{ message }}
    </div>
    {% endif %}

    {% if let Some(message) = general_error %}
    <div class="{{ alert_error }}" role="alert">
        <strong class="font-semibold">Error:</strong> {{ message }}
    </div>
    {% endif %}

    <article class="{{ card_base }} space-y-6">
        <header class="flex items-center gap-2 text-xl font-semibold text-white">
            <i data-feather="user-plus" class="h-5 w-5 text-gray-400"></i>
            Add user
        </header>
        <form method="post" action="/admin/users" class="space-y-6">
            {% if let Some(csrf) = layout.csrf %}
            <input type="hidden" name="csrf_token" value="{{ csrf.token }}" />
            {% endif %}

            <div class="grid gap-6 md:grid-cols-2">
                <label for="add-user-username" class="md:col-span-2 flex flex-col text-sm font-semibold text-gray-200">
                    Username
                    <input
                        id="add-user-username"
                        name="username"
                        type="text"
                        autocomplete="username"
                        value="{{ add_form.username }}"
                        minlength="3"
                        maxlength="64"
                        required
                        class="{{ input_class }}"
                    />
                    {% if let Some(err) = add_errors.username %}
                    <small class="mt-2 text-sm font-medium text-rose-300">{{ err }}</small>
                    {% else %}
                    <small class="mt-2 text-sm text-gray-400">Lowercase letters, numbers, hyphen or period are recommended.</small>
                    {% endif %}
                </label>

                <label for="add-user-password" class="flex flex-col text-sm font-semibold text-gray-200">
                    Password
                    <input
                        id="add-user-password"
                        name="password"
                        type="password"
                        autocomplete="new-password"
                        minlength="12"
                        required
                        class="{{ input_class }}"
                    />
                    {% if let Some(err) = add_errors.password %}
                    <small class="mt-2 text-sm font-medium text-rose-300">{{ err }}</small>
                    {% else %}
                    <small class="mt-2 text-sm text-gray-400">Minimum 12 characters.</small>
                    {% endif %}
                </label>

                <label for="add-user-password-confirm" class="flex flex-col text-sm font-semibold text-gray-200">
                    Confirm password
                    <input
                        id="add-user-password-confirm"
                        name="password_confirm"
                        type="password"
                        autocomplete="new-password"
                        minlength="12"
                        required
                        class="{{ input_class }}"
                    />
                    {% if let Some(err) = add_errors.password_confirm %}
                    <small class="mt-2 text-sm font-medium text-rose-300">{{ err }}</small>
                    {% endif %}
                </label>
            </div>

            <label for="add-user-is-admin" class="flex items-center gap-3 text-sm font-medium text-gray-200">
                <input type="checkbox" id="add-user-is-admin" name="is_admin" {% if add_form.is_admin %}checked{% endif %} class="h-4 w-4 rounded border-gray-700 bg-gray-900 text-sky-500 focus:ring-sky-400" />
                Grant administrator privileges
            </label>

            <div class="flex justify-end">
                <button type="submit" class="{{ button_primary }}">
                    <i data-feather="user-plus" class="h-4 w-4"></i>
                    Create user
                </button>
            </div>
        </form>
    </article>

    <section class="space-y-4">
        <h2 class="flex items-center gap-2 text-2xl font-semibold text-white">
            <i data-feather="shield" class="h-6 w-6 text-gray-400"></i>
            Existing users
        </h2>
        {% if users.is_empty() %}
        <p class="text-sm text-gray-400">No users found.</p>
        {% else %}
        <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
            {% for user in users %}
            <article class="{{ card_base }} space-y-4">
                <header class="flex items-start justify-between gap-3">
                    <div>
                        <h3 class="text-lg font-semibold text-white">{{ user.username }}</h3>
                        <!--<small class="text-sm text-gray-400">Created {{ user.created_display }}</small>-->
                    </div>
                    {% if user.is_admin %}
                    <span class="inline-flex items-center gap-2 rounded-full bg-sky-500/15 px-3 py-1 text-xs font-semibold text-sky-200 ring-1 ring-inset ring-sky-500/40">
                        <i data-feather="star" class="h-4 w-4"></i>
                        Admin
                    </span>
                    {% endif %}
                </header>

                <p class="text-sm text-gray-300">
                    {% if let Some(last_seen) = user.last_login_display %}
                    Last login: {{ last_seen }}
                    {% else %}
                    Last login: never
                    {% endif %}
                </p>

                <details class="rounded-xl border border-gray-800 bg-gray-900/60 p-4">
                    <summary class="cursor-pointer text-sm font-semibold text-gray-200">Reset password</summary>
                    <form method="post" action="/admin/users/{{ user.id }}/reset-password" class="mt-4 space-y-4">
                        {% if let Some(csrf) = layout.csrf %}
                        <input type="hidden" name="csrf_token" value="{{ csrf.token }}" />
                        {% endif %}

                        <label class="flex flex-col text-sm font-semibold text-gray-200">
                            New password
                            <input type="password" name="new_password" minlength="12" required autocomplete="new-password" class="{{ input_class }}" />
                        </label>
                        <label class="flex flex-col text-sm font-semibold text-gray-200">
                            Confirm password
                            <input type="password" name="confirm_password" minlength="12" required autocomplete="new-password" class="{{ input_class }}" />
                        </label>
                        <button type="submit" class="{{ button_secondary }}">
                            <i data-feather="refresh-cw" class="h-4 w-4"></i>
                            Reset password
                        </button>
                    </form>
                </details>

                <form method="post" action="/admin/users/{{ user.id }}/delete" onsubmit="return confirm('Delete user {{ user.username }}? This action cannot be undone.');">
                    {% if let Some(csrf) = layout.csrf %}
                    <input type="hidden" name="csrf_token" value="{{ csrf.token }}" />
                    {% endif %}
                    <button type="submit" class="{{ button_danger }} w-full justify-center">
                        <i data-feather="trash-2" class="h-4 w-4"></i>
                        Delete user
                    </button>
                </form>
            </article>
            {% endfor %}
        </div>
        {% endif %}
    </section>
</section>
{% endblock %}
