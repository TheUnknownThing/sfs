{% extends "base.html" %}

{% block content %}
{% set card_base = "rounded-2xl border border-slate-800 bg-slate-900/70 p-6 shadow-xl shadow-slate-950/40 backdrop-blur" %}
{% set card_success = "rounded-2xl border border-emerald-500/60 bg-emerald-500/10 p-4 text-emerald-100 shadow-lg shadow-emerald-500/20 backdrop-blur" %}
{% set button_primary = "inline-flex items-center justify-center gap-2 rounded-lg bg-sky-500 px-4 py-2 text-sm font-semibold text-slate-950 shadow-sm transition hover:bg-sky-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-300" %}
{% set button_outline = "inline-flex items-center justify-center gap-2 rounded-lg border border-slate-700 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:border-sky-400 hover:text-white focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-300" %}
{% set button_subtle = "inline-flex items-center justify-center gap-2 rounded-lg bg-slate-800 px-4 py-2 text-sm font-semibold text-slate-100 shadow-sm transition hover:bg-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-300" %}

<div class="mx-auto flex w-full max-w-3xl flex-col gap-8 py-10">
  {% if let Some(message) = flash_message %}
  <article class="{{ card_success }}" role="status">
    <p class="flex items-center gap-2 text-sm font-medium">
      <i data-feather="check-circle" class="h-4 w-4"></i>
      {{ message }}
    </p>
  </article>
  {% endif %}

  <article class="{{ card_base }} space-y-4">
    <div>
      <h2 class="text-xl font-semibold text-white">Upload files</h2>
      <p class="mt-1 text-sm text-slate-400">
        Share files securely with a single code.
      </p>
    </div>
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:gap-4">
      {% if layout.current_user.is_some() %}
      <a class="{{ button_primary }}" href="/upload">
        <i data-feather="upload" class="h-4 w-4"></i>
        Upload a file
      </a>
      <a class="{{ button_outline }}" href="/paste">
        <i data-feather="edit-3" class="h-4 w-4"></i>
        Create a paste
      </a>
      {% else %}
      <p class="text-sm text-slate-400">Please log in to upload.</p>
      <a class="{{ button_primary }}" href="/login">
        <i data-feather="log-in" class="h-4 w-4"></i>
        Log in
      </a>
      {% endif %}
    </div>
  </article>

  <article class="{{ card_base }} space-y-6">
    <div>
      <h2 class="text-xl font-semibold text-white">Fetch files</h2>
      <p class="mt-2 text-sm text-slate-400">
        Enter a share code (e.g. <code class="rounded bg-slate-900/80 px-2 py-1 text-xs font-semibold text-slate-200">ABCD-EF12</code>)
      </p>
    </div>
    <form
      id="code-lookup-form"
      action="/f/"
      method="get"
      novalidate
      class="flex flex-col items-center gap-6 text-center sm:items-start sm:text-left"
    >
      <div class="code-input-grid flex flex-wrap items-center justify-center gap-2 sm:gap-3" role="group" aria-label="File code">
        {% for index in 0..8 %}
        {% if index == 4 %}
        <span class="code-input-separator flex h-12 items-center justify-center px-1 text-2xl font-semibold text-slate-600 sm:h-14" aria-hidden="true">-</span>
        {% endif %}
        <div class="code-input-wrapper relative group" data-index="{{ index }}" data-filled="false">
          <input
            class="code-input h-12 w-10 rounded-xl border border-slate-800 bg-slate-900/80 text-center text-lg font-semibold uppercase tracking-[0.35em] text-white transition focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-500/40 group-data-[filled=true]:border-sky-400/70 sm:h-14 sm:w-12 sm:text-xl"
            type="text"
            inputmode="text"
            autocomplete="one-time-code"
            autocapitalize="characters"
            maxlength="1"
            aria-label="Code character {{ index + 1 }}"
          />
        </div>
        {% endfor %}
      </div>
      <input
        type="hidden"
        name="code"
        id="code-lookup-hidden"
        pattern="^[A-Za-z0-9]{4}-[A-Za-z0-9]{4}$"
        required
      />
      <button type="submit" class="{{ button_primary }}">
        <i data-feather="arrow-right" class="h-4 w-4"></i>
        Fetch file
      </button>
      <p class="text-sm text-slate-400">Paste the code or type one character per box.</p>
    </form>
  </article>
</div>

{% if layout.current_user.is_some() %}
<section class="mx-auto mt-12 w-full max-w-6xl space-y-6">
  <div>
    <h2 class="flex items-center gap-3 text-xl font-semibold text-white">
      <i data-feather="clock" class="h-6 w-6 text-slate-400"></i>
      Recent uploads
    </h2>
  </div>
  {% if recent_uploads.is_empty() %}
  <article class="{{ card_base }} text-center text-sm text-slate-400">
    No uploads yet. <a href="/upload" class="text-sky-400 transition hover:text-sky-300">Upload your first file</a> to get started.
  </article>
  {% else %}
  <div class="overflow-hidden rounded-2xl border border-slate-800 bg-slate-900/60 shadow-xl shadow-slate-950/40">
    <table role="grid" class="min-w-full divide-y divide-slate-800 text-left text-sm text-slate-200">
      <thead class="bg-slate-900/80 text-xs font-semibold uppercase tracking-wide text-slate-400">
        <tr>
          <th scope="col" class="px-4 py-3">File name</th>
          <th scope="col" class="px-4 py-3">Code</th>
          <th scope="col" class="px-4 py-3">Size</th>
          <th scope="col" class="px-4 py-3">Uploaded</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-800">
        {% for upload in recent_uploads %}
        <tr class="hover:bg-slate-900/70">
          <td class="px-4 py-3">
            <a href="/f/{{ upload.code }}" class="inline-flex items-center gap-2 font-medium text-white transition hover:text-sky-300">
              <i data-feather="file" class="h-4 w-4 text-slate-400"></i>
              {{ upload.original_name }}
            </a>
          </td>
          <td class="px-4 py-3">
            <code class="rounded bg-slate-900/80 px-2 py-1 text-xs font-semibold text-slate-200">{{ upload.code }}</code>
          </td>
          <td class="px-4 py-3">{{ upload.size_display }}</td>
          <td class="px-4 py-3"><time class="text-slate-400">{{ upload.created_display }}</time></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</section>
{% endif %}
{% endblock %}

{% block body_scripts %}
<script>
  (() => {
    "use strict";

    const form = document.getElementById("code-lookup-form");
    if (!form) {
      return;
    }

    const inputs = Array.from(form.querySelectorAll(".code-input"));
    const hiddenField = document.getElementById("code-lookup-hidden");
    const hyphenIndex = 4;

    const sanitize = (value) =>
      value.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();

    const updateHiddenValue = () => {
      const raw = inputs.map((input) => input.value).join("");
      if (raw.length === inputs.length) {
        hiddenField.value = `${raw.slice(0, hyphenIndex)}-${raw.slice(
          hyphenIndex
        )}`;
      } else {
        hiddenField.value = "";
      }
    };

    const focusInput = (index) => {
      const target = inputs[index];
      if (target) {
        target.focus();
        target.select();
      }
    };

    const markWrapperState = (input) => {
      if (input && input.parentElement?.classList) {
        input.parentElement.dataset.filled = input.value ? "true" : "false";
      }
    };

    const fillFrom = (startIndex, characters) => {
      let index = startIndex;
      characters.forEach((char) => {
        if (index >= inputs.length) {
          return;
        }
        const sanitizedChar = sanitize(char).slice(0, 1);
        if (!sanitizedChar) {
          return;
        }
        inputs[index].value = sanitizedChar;
        inputs[index].setCustomValidity("");
        markWrapperState(inputs[index]);
        index += 1;
      });
      updateHiddenValue();
      if (index < inputs.length) {
        focusInput(index);
      } else {
        focusInput(inputs.length - 1);
      }
    };

    inputs.forEach((input) => markWrapperState(input));

    inputs.forEach((input, index) => {
      input.addEventListener("focus", () => input.select());

      input.addEventListener("input", (event) => {
        const value = sanitize(event.target.value);

        if (value.length > 1) {
          fillFrom(index, value.split(""));
          return;
        }

        event.target.value = value;
        event.target.setCustomValidity("");
        markWrapperState(event.target);

        if (value && index < inputs.length - 1) {
          focusInput(index + 1);
        }

        updateHiddenValue();
      });

      input.addEventListener("keydown", (event) => {
        if (event.key === "Backspace" && !input.value && index > 0) {
          event.preventDefault();
          focusInput(index - 1);
          return;
        }

        if (
          event.key === "ArrowLeft" &&
          index > 0 &&
          input.selectionStart === 0
        ) {
          event.preventDefault();
          focusInput(index - 1);
          return;
        }

        if (
          event.key === "ArrowRight" &&
          index < inputs.length - 1 &&
          input.selectionStart === input.value.length
        ) {
          event.preventDefault();
          focusInput(index + 1);
        }
      });

      input.addEventListener("paste", (event) => {
        const clipboardData = event.clipboardData || window.clipboardData;
        if (!clipboardData) {
          return;
        }
        event.preventDefault();
        const text = sanitize(clipboardData.getData("text"));
        if (!text) {
          return;
        }
        fillFrom(index, text.split(""));
      });
    });

    form.addEventListener("submit", (event) => {
      updateHiddenValue();

      if (!hiddenField.value) {
        event.preventDefault();
        const firstEmpty = inputs.find((input) => !input.value);
        if (firstEmpty) {
          firstEmpty.setCustomValidity("Enter the remaining characters.");
          firstEmpty.reportValidity();
          focusInput(inputs.indexOf(firstEmpty));
        }
        return;
      }

      inputs.forEach((input) => input.setCustomValidity(""));
      event.preventDefault();
      const targetCode = hiddenField.value;
      window.location.href = `/f/${encodeURIComponent(targetCode)}`;
    });

    updateHiddenValue();
  })();
</script>
{% endblock %}
